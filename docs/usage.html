<!DOCTYPE html>
<html>
<head>
    <title>Usage - Patchwork</title>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <link rel="stylesheet" href="../style.css" type="text/css">
    
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/styles/tomorrow.min.css">
    <script src="//cdnjs.cloudflare.com/ajax/libs/highlight.js/9.1.0/highlight.min.js"></script>
    <script>hljs.initHighlightingOnLoad();</script>
    
    <style type="text/css">
        pre {
            background: #F4F4F4;
            border-radius: 5px;
            padding: 0;
            font-size: 14px;
            line-height: 1.2em;
        }
        
        code {
            background: transparent !important;
            font: inherit;
            margin: 0;
            padding: 0.5em;
        }
        
        table.matches td {
            text-align: center;
            padding-top: 2px;
            padding-bottom: 2px;
        }
        
        table.matches tr:nth-child(even) td {
            background: #F4F4F4;
        }
        
        table.matches td.yes {
            color: #090;
            text-shadow: 0 0 7px #090;
        }
        
        table.matches td.no {
            color: #900;
            text-shadow: 0 0 7px #900;
        }
        
        table.matches {
            width: 100%;
            border-collapse: collapse;
            margin-top: 15px;
        }
    </style>
    
    <script>
      (function(i,s,o,g,r,a,m){i['GoogleAnalyticsObject']=r;i[r]=i[r]||function(){
      (i[r].q=i[r].q||[]).push(arguments)},i[r].l=1*new Date();a=s.createElement(o),
      m=s.getElementsByTagName(o)[0];a.async=1;a.src=g;m.parentNode.insertBefore(a,m)
      })(window,document,'script','//www.google-analytics.com/analytics.js','ga');

      ga('create', 'UA-20483190-1', 'auto');
      ga('send', 'pageview');

    </script>
</head>
<body>
    <div id="nav">
        <a href="setup.html">Setup</a>
        <a href="usage.html">Usage</a>
        <a href="implementation.html">Implementation</a>
        <a href="changelog.html">Changelog</a>
        <a href="license.html">License</a>
        <a href="https://github.com/antecedent/patchwork">GitHub</a>
    </div>
    <div id="top-outer" class="for-docs">
        <div id="top">
            <div id="square-pattern">
                <div style="background: rgb(190,216,244);"></div>
                <div style="background: rgb(191,216,242);"></div>
                <div style="background: rgb(189,212,240);"></div>
                <div style="background: rgb(191,213,245);"></div>
                <div style="background: rgb(194,216,236);"></div>
                <div style="background: rgb(184,210,249);"></div>
                <div style="background: rgb(196,210,243);"></div>
                <div style="background: rgb(184,218,249);"></div>
                <div style="background: rgb(192,209,253);"></div>
                <div style="background: rgb(193,210,245);"></div>
                <div style="background: rgb(187,219,247);"></div>
                <div style="background: rgb(188,215,246);"></div>
                <div style="background: rgb(189,217,242);"></div>
                <div style="background: rgb(190,216,244);"></div>
                <div style="background: rgb(190,216,244);"></div>
                <div style="background: rgb(191,216,245);"></div>
                <div style="background: rgb(187,218,243);"></div>
                <div style="background: rgb(192,218,240);"></div>
                <div style="background: rgb(192,219,250);"></div>
                <div style="background: rgb(188,221,235);"></div>
                <div style="background: rgb(185,213,250);"></div>
                <div style="background: rgb(200,221,244);"></div>
                <div style="background: rgb(181,213,243);"></div>
                <div style="background: rgb(187,218,239);"></div>
                <div style="background: rgb(187,215,238);"></div>
                <div style="background: rgb(189,212,240);"></div>
            </div>
            <div id="header">
                <h1><a href="../">Patchwork</a></h1>
            </div>
        </div>
    </div>

    <div id="main-outer">
        <div id="main">
            <h3>Usage</h3>

            <div class="separator"></div>
            
            <p class="precaution">This is the documentation for version 1.4, but it is currently missing some sections of lower importance, namely ones on caching, warning suppression and stacked redefinitions.</p>

            <table class="usage-section" id="lifecycle-of-a-redefinition">
            <tr>
            <th class="left">
                <h4>Lifecycle of a redefinition</h4>
            </th>
            <td class="right">
                <p class="first">These functions (from the <kbd>Patchwork</kbd> namespace) manage the lifecycle of redefinitions:</p>
                <ul>
                    <li><kbd>redefine($what, $asWhat)</kbd> introduces a redefinition,</li>
                    <li><kbd>relay([$newArgs])</kbd>, when called from within a redefinition, calls the original definition,</li>
                    <li><kbd>restore($handle)</kbd> expires a redefinition; <kbd>$handle</kbd> is the corresponding result of <kbd>redefine</kbd>,</li>
                    <li><kbd>restoreAll()</kbd> expires all redefinitions.</li>
                </ul>
                <p>The following control flow graphic illustrates the behavior of these four routines:</p>
                <p><img src="usage/flow.png" width="100%"></p>
            </td>
            </tr>
            </table>

            <div class="separator"></div>


            <table class="usage-section" id="closures-as-method-bodies">
            <tr>
            <td class="left">
                <p class="first">The new body for a method being redefined can be taken from any callable, but closures are arguably the most convenient:</p>
                
                <pre><code class="php">redefine('Cache::store', function ($key, $value)
{
    # Works only if store() is static
    $this-><span class="hint" title="PHPUnit is assumed.">assertEquals</span>(['foo', 'bar'], [$key, $value]);
});</code></pre>
                <p>In the above example, <kbd>Cache::store()</kbd> was assumed to be a static method.</p>
                
                <p>In case it is not, it will fail, because <kbd>$this</kbd> will refer to the instance it was called on (one of <kbd>Cache</kbd>), analogously to the following scenario:</p>
                
                <pre><code class="php">$phpUnit = $this;

redefine('Collection::offsetGet', function ($offset) use ($phpUnit)
{
    $phpUnit->assertTrue($this->offsetExists($offset));
    return 123;
});</code></pre>
                
                <p>Please also note that <kbd>get_called_class()</kbd>, </kbd><kbd>static::class</kbd>, <kbd>self::class</kbd>, <kbd>__CLASS__</kbd>, <kbd>__TRAIT__</kbd>, <kbd>__METHOD__</kbd> and <kbd>__FUNCTION__</kbd> will not expand &ldquo;as expected&rdquo;. In other words, their behavior will disregard the <a href="implementation.html">redefinition metaphor</a>:</p>
            
            <pre><code class="php">redefine('Foo::bar', function()
{
    $this->assertEquals('RedefinitionTest', __CLASS__);
    $this->assertEquals('testMagicConstants', __FUNCTION__);
});</code></pre>
            
            <p>As a solution, Patchwork provides substitutes:</p>
            
<pre><code class="php">use function Patchwork\{getClass, getCalledClass, getMethod, getFunction};

redefine('Foo::bar', function()
{
    $this->assertEquals('Foo', getClass());
    $this->assertContains('Foo', class_parents(getCalledClass());
    $this->assertEquals('bar', getFunction());
    $this->assertEquals('Foo::bar', getMethod());
});</code></pre>
            </td>
            <th class="right">
                <h4>Closures as method bodies</h4>
            </th>
            </tr>
            </table>
            
            <div class="separator"></div>
            
            
            <table class="usage-section" id="wildcards">
            <tr>
            <th class="left">
                <h4>Wildcards</h4>
            </th>
            <td class="right">
                <p class="first">For its first argument, <kbd>redefine()</kbd> allows not only regular callbacks, but also wildcards. The following table shows which methods (columns) are captured by which references (rows):</p>
                <table class="matches">
                    <tr>
                        <td style="text-align: right; padding-right: 15px;">&nbsp;</td>
                        <td><kbd>Foo::spam</kbd></td>
                        <td><kbd>Foo::eggs</kbd></td>
                        <td><kbd>Bar::spam</kbd></td>
                        <td><kbd>Bar::eggs</kbd></td>
                        <td><kbd>App\X::babble</kbd></td>
                        <td><kbd>App\run</kbd></td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>*</kbd></td>
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>Foo::*</kbd></td>
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>Bar</kbd></td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>*::spam</kbd></td>
                        <td class="yes">+</td>
                        <td class="no">–</td>
                        <td class="yes">+</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>eggs</kbd></td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>                        
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>App\*</kbd></td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>                        
                        <td class="yes">+</td>
                        <td class="yes">+</td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>App</kbd></td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>                        
                        <td class="no">–</td>
                        <td class="no">–</td>
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>App\run</kbd></td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>                        
                        <td class="no">–</td>  
                        <td class="yes">+</td>                        
                    </tr>
                    <tr>
                        <td style="text-align: right; padding-right: 15px;"><kbd>run</kbd></td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>
                        <td class="no">–</td>                        
                        <td class="no">–</td>  
                        <td class="no">–</td> 
                    </tr>
                </table>
                
                <p>Callbacks of the form <kbd>[$instance, 'method']</kbd> are also permitted, and work as expected – by restricting the redefinition to a specifing instance.</p>
                
                <p>Also, <kbd>[Foo::class, 'spam']</kbd> is synonymous with <kbd>'Foo::spam'</kbd>, and has the added benefit of avoiding namespace prefixes.</p>
            </td>
            </tr>
            </table>


            <div class="separator"></div>
            
            <table class="usage-section" id="inherited-methods">
            <tr>
            <td class="left">
                <p class="first">A method might exist in a class, like <kbd>Bar::spam</kbd> below does, only by virtue of being inherited.</p>
                
                <pre><code class="php">class Foo
{
    static function spam()
    {
    }
}

class Bar extends Foo
{
}</code></pre>
                <p>In this scenario:</p>
                <ul>
                    <li><kbd>redefine('Foo::spam', $r)</kbd> would both affect calls to <kbd>Foo::spam</kbd> and to <kbd>Bar::spam</kbd>, and</li>
                    <li><kbd>redefine('Bar::spam', $r)</kbd> would only affect calls to <kbd>Bar::spam</kbd>.</li>
                </ul>
            </td>
            <th class="right">
                <h4>Inherited methods</h4>
            </th>
            </tr>
            </table>
            
            <!--
            <div class="separator"></div>
            
            <table class="usage-section" id="caching">
            <tr>
            <th class="left">
                <h4>Caching</h4>
            </th>
            <td class="right">
                <p class="first">To be written.</p>
            </td>
            </tr>
            </table>
            
            <div class="separator"></div>
            
            <table class="usage-section" id="suppressing-warnings">
            <tr>
            <td class="left">
                <p class="first">To be written.</p>
            </td>
            <th class="right">
                <h4>Suppressing warnings</h4>
            </th>
            </tr>
            </table>
            
             <div class="separator"></div>
            
            <table class="usage-section" id="stacking-redefinitions">
            <tr>
            <th class="left">
                <h4>Stacking redefinitions</h4>
            </th>
            <td class="right">
                <p class="first">To be written.</p>
            </td>
            </tr>
            </table>   
            -->
            
            <div class="separator"></div>

            <div id="disqus_thread"></div>
            <script type="text/javascript">
                var disqus_shortname = 'antecedentgithub';
                var disqus_identifier = '/patchwork/docs/usage.html';
                var disqus_url = 'http://antecedent.github.com/patchwork/docs/usage.html';
                (function() {
                    var dsq = document.createElement('script'); dsq.type = 'text/javascript'; dsq.async = true;
                    dsq.src = 'http://' + disqus_shortname + '.disqus.com/embed.js';
                    (document.getElementsByTagName('head')[0] || document.getElementsByTagName('body')[0]).appendChild(dsq);
                })();
            </script>
            <noscript>Please enable JavaScript to view the <a href="http://disqus.com/?ref_noscript">comments powered by Disqus.</a></noscript>
        </div>
    </div>
</body>
</html>
